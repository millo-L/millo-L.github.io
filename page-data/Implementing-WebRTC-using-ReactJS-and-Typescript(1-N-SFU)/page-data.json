{"componentChunkName":"component---src-components-post-post-page-tsx","path":"/Implementing-WebRTC-using-ReactJS-and-Typescript(1-N-SFU)/","result":{"data":{"markdownRemark":{"html":"<h1 id=\"1-introduction\" style=\"position:relative;\"><a href=\"#1-introduction\" aria-label=\"1 introduction permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Introduction</h1>\n<p>Last time, I posted for <a href=\"https://millo-l.github.io/Implementing-WebRTC-using-ReactJS-and-Typescript(1-N-P2P)/\">1:N P2P communication using WebRTC</a>. I thought about posting about the SFU method or not, but I thought it would be better to do it. SFU is a type of Media Server, so please click <a href=\"https://millo-l.github.io/WebRTC-implementation-method(Mesh-SFU-MCU)/\">here</a> to check the past posting. Media servers are used during commercialization using <a href=\"https://www.kurento.org/\">Kurento</a> and <a href=\"https://mediasoup.org/documentation/\">mediasoup</a>. However, based on his theory, I wanted to organize an SFU server among media servers. The theoretical explanation was covered in the existing post, so please check the link here above. Assuming that you know all the theoretical backgrounds, I will write a post about the implementation.</p>\n<h1 id=\"2-code\" style=\"position:relative;\"><a href=\"#2-code\" aria-label=\"2 code permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Code</h1>\n<h2 id=\"sfu-servernodejs\" style=\"position:relative;\"><a href=\"#sfu-servernodejs\" aria-label=\"sfu servernodejs permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SFU Server(Node.js)</h2>\n<blockquote>\n<p><strong>Note</strong> <br /> You must use socket.io version=2.3.0.</p>\n</blockquote>\n<h3>1. Variable Description</h3>\n<ul>\n<li>\n<p>receiverPCs</p>\n<ul>\n<li>\n<p>role</p>\n<ul>\n<li>Save RTCPeerConnection to receive MediaStream of connected user</li>\n</ul>\n</li>\n<li>\n<p>format</p>\n<ul>\n<li>receiverPCs[socketID of the user connected user] = RTCPeerConnection</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>senderPCs</p>\n<ul>\n<li>\n<p>role</p>\n<ul>\n<li>Save RTCPeerConnection to send one user MediaStream of another user except yourself</li>\n</ul>\n</li>\n<li>\n<p>format</p>\n<ul>\n<li>senderPCs[socketID of user sending MediaStream] = [{id: socketID of user receiving MediaStream, pc: RTCPeerConnection for sending MediaStream}, ...]</li>\n<li>senderPCs[socketID] = Array&#x3C;{id: string, pc: RTCPeerConnection}></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>users</p>\n<ul>\n<li>\n<p>role</p>\n<ul>\n<li>Save MediaStream received via RTCPeerConnection connected from receiverPCs with user's socketID</li>\n</ul>\n</li>\n<li>\n<p>format</p>\n<ul>\n<li>users[roomID] = [{id: socketID of user sending MediaStream, stream: MedaiStream sent by user via RTCPeerConnection}]</li>\n<li>users[roomID] = Array&#x3C;{id: string, stream: MediaStream}></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>socketToRoom</p>\n<ul>\n<li>\n<p>role</p>\n<ul>\n<li>Save which room the user belongs to</li>\n</ul>\n</li>\n<li>\n<p>format</p>\n<ul>\n<li>socketToRoom[socketID] = Room ID to which user belongs</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> receiverPCs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">let</span> senderPCs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">let</span> users <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">let</span> socketToRoom <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h3>2. socket 이벤트</h3>\n<ul>\n<li>\n<p>joinRoom</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>id: Socket ID of the user joining the room</li>\n<li>room: room id</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Send a list of socket id of users who are already in the room and sending their MediaStream to the server to the user who is now in.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"joinRoom\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> allUsers <span class=\"token operator\">=</span> <span class=\"token function\">getOtherUsersInRoom</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>roomID<span class=\"token punctuation\">)</span>\n        io<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"allUsers\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> users<span class=\"token operator\">:</span> allUsers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>senderOffer</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>senderSocketID: socket id of user who sent the offer of RTCPeerConnection that sends his MediaStream data to server</li>\n<li>roomID: Room ID to which user wants to belong</li>\n<li>sdp: RTCSessionDescription of user sending offer</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Server received the offer of RTCPeerConnection to receive user's MediaStream and sent answer</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p><strong>Note</strong> <br /> The reason why createAnswer keeps both of <strong>offerToReceiveAudio</strong> and <strong>offerToReceiveVideo</strong> true is that they must receive both audio and video streams from users.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"senderOffer\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        socketToRoom<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>senderSocketID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>roomID\n        <span class=\"token keyword\">let</span> pc <span class=\"token operator\">=</span> <span class=\"token function\">createReceiverPeerConnection</span><span class=\"token punctuation\">(</span>\n            data<span class=\"token punctuation\">.</span>senderSocketID<span class=\"token punctuation\">,</span>\n            socket<span class=\"token punctuation\">,</span>\n            data<span class=\"token punctuation\">.</span>roomID\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>sdp<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> sdp <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">createAnswer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            offerToReceiveAudio<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            offerToReceiveVideo<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span>sdp<span class=\"token punctuation\">)</span>\n        socket<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>roomID<span class=\"token punctuation\">)</span>\n        io<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>senderSocketID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getSenderAnswer\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> sdp <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>senderCandidate</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>senderSocketID: Socket id of user who sent the candidate of RTCPeerConnection that sends his MediaStream data to the server</li>\n<li>candidate: RTCIceCandidate of user</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Add RTCIceCandidate to the RTCPeerConnection saved when the user sends an off</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"senderCandidate\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> pc <span class=\"token operator\">=</span> receiverPCs<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>senderSocketID<span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">addIceCandidate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">wrtc<span class=\"token punctuation\">.</span>RTCIceCandidate</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>receiverOffer</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>receiverSocketID: Socket id of user who sent an offer of RTCPeerConnection to receive MediaStream of user who has senderSocketID as socket id</li>\n<li>senderSocketID: socket id of user with RTCPeerConnection to send their MediaStream to server</li>\n<li>roomID: Room ID to which both receiverSocketID and senderSocketID belong</li>\n<li>sdp: RTCSessionDescription of user sending offer</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>User who has reciverSocketID as socketid receives an offer of RTCPeerConnection to receive MediaStream of user who has senderSocketID as socketid, and sends an answer</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p><strong>Note</strong> <br /> The reason why createAnswer has false versions of both <strong>offerToReceiveAudio</strong> and <strong>offerToReceiveVideo</strong> is that they do not receive audio and video streams from users.(The RTCPeerConnection you created now is a connection to send a stream of existing users.)</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"receiverOffer\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> pc <span class=\"token operator\">=</span> <span class=\"token function\">createSenderPeerConnection</span><span class=\"token punctuation\">(</span>\n            data<span class=\"token punctuation\">.</span>receiverSocketID<span class=\"token punctuation\">,</span>\n            data<span class=\"token punctuation\">.</span>senderSocketID<span class=\"token punctuation\">,</span>\n            socket<span class=\"token punctuation\">,</span>\n            data<span class=\"token punctuation\">.</span>roomID\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>sdp<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> sdp <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">createAnswer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            offerToReceiveAudio<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n            offerToReceiveVideo<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span>sdp<span class=\"token punctuation\">)</span>\n        io<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>receiverSocketID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getReceiverAnswer\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            id<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>senderSocketID<span class=\"token punctuation\">,</span>\n            sdp<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>receiverCandidate</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>Socket id of user who sent an offfer of RTCPeerConnection to receive MediaStream of user who has senderSocketID as socket id</li>\n<li>senderSocketID: socket id of user with RTCPeerConnection to send their MediaStream to server</li>\n<li>candidate: RTCIceCandidate of user who has reciverSocketID as socket id</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Add RTCIceCandidate to RTCPeerConnection saved when user with reciverSocketID as socketid</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"receiverCandidate\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> senderPC <span class=\"token operator\">=</span> senderPCs<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>senderSocketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>\n            <span class=\"token parameter\">sPC</span> <span class=\"token operator\">=></span> sPC<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> data<span class=\"token punctuation\">.</span>receiverSocketID\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> senderPC<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>pc<span class=\"token punctuation\">.</span><span class=\"token function\">addIceCandidate</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">wrtc<span class=\"token punctuation\">.</span>RTCIceCandidate</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>disconnect</p>\n<ul>\n<li>\n<p>role</p>\n<ul>\n<li>Turn off all RTCPeerConnection and MedaiStream associated with disconnected users</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"disconnect\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> roomID <span class=\"token operator\">=</span> socketToRoom<span class=\"token punctuation\">[</span>socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span>\n\n        <span class=\"token function\">deleteUser</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> roomID<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">closeRecevierPC</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">closeSenderPCs</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n\n        socket<span class=\"token punctuation\">.</span>broadcast<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>roomID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userExit\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> socket<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>3. Function description</h3>\n<ul>\n<li>\n<p>isIncluded</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>array: Array</li>\n<li>id: string</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Returns if any of the Dictionaries in the array have an id match</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isIncluded</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">array<span class=\"token punctuation\">,</span> id</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> array<span class=\"token punctuation\">.</span>length\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>array<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>createReceiverPeerConnection</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>socketID: string</li>\n<li>socket: socketio.Socket</li>\n<li>roomID: string</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Save the newly created pc as the value of reciverPCs with user's socketID as key and create an event to receive user's MediaStream through that pc</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createReceiverPeerConnection</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">socketID<span class=\"token punctuation\">,</span> socket<span class=\"token punctuation\">,</span> roomID</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> pc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">wrtc<span class=\"token punctuation\">.</span>RTCPeerConnection</span><span class=\"token punctuation\">(</span>pc_config<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>receiverPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> receiverPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> pc\n    <span class=\"token keyword\">else</span> receiverPCs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>receiverPCs<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> pc <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onicecandidate</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//console.log(`socketID: ${socketID}'s receiverPeerConnection icecandidate`);</span>\n        socket<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>socketID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getSenderCandidate\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            candidate<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">oniceconnectionstatechange</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//console.log(e);</span>\n    <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">ontrack</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isIncluded</span><span class=\"token punctuation\">(</span>users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> socketID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                    id<span class=\"token operator\">:</span> socketID<span class=\"token punctuation\">,</span>\n                    stream<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>streams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span>\n                    id<span class=\"token operator\">:</span> socketID<span class=\"token punctuation\">,</span>\n                    stream<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>streams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n        socket<span class=\"token punctuation\">.</span>broadcast<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>roomID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userEnter\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> socketID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> pc\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>createSenderPeerConnection</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>receiverSocketID: string</li>\n<li>senderSocketID: string</li>\n<li>socket: socketio.Socket</li>\n<li>roomID: string</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>It creates an RTCPeerConnection to deliver the user's MediaStream with the senderSocketID to the user with the receiverSockerID, and adds the video track and audio track of the senderSocketID user to the corresponding RTCPeerConnection.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createSenderPeerConnection</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">receiverSocketID<span class=\"token punctuation\">,</span>\n    senderSocketID<span class=\"token punctuation\">,</span>\n    socket<span class=\"token punctuation\">,</span>\n    roomID</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> pc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">wrtc<span class=\"token punctuation\">.</span>RTCPeerConnection</span><span class=\"token punctuation\">(</span>pc_config<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>senderPCs<span class=\"token punctuation\">[</span>senderSocketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        senderPCs<span class=\"token punctuation\">[</span>senderSocketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> user<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> receiverSocketID<span class=\"token punctuation\">)</span>\n        senderPCs<span class=\"token punctuation\">[</span>senderSocketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> receiverSocketID<span class=\"token punctuation\">,</span> pc<span class=\"token operator\">:</span> pc <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span>\n        senderPCs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>senderPCs<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">[</span>senderSocketID<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> receiverSocketID<span class=\"token punctuation\">,</span> pc<span class=\"token operator\">:</span> pc <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onicecandidate</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//console.log(`socketID: ${receiverSocketID}'s senderPeerConnection icecandidate`);</span>\n        socket<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>receiverSocketID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getReceiverCandidate\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            id<span class=\"token operator\">:</span> senderSocketID<span class=\"token punctuation\">,</span>\n            candidate<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">oniceconnectionstatechange</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//console.log(e);</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> sendUser <span class=\"token operator\">=</span> users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> user<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> senderSocketID<span class=\"token punctuation\">)</span>\n    sendUser<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">.</span><span class=\"token function\">getTracks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">track</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        pc<span class=\"token punctuation\">.</span><span class=\"token function\">addTrack</span><span class=\"token punctuation\">(</span>track<span class=\"token punctuation\">,</span> sendUser<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> pc\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>getOtherUsersInRoom</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>socketID: string</li>\n<li>roomID: string</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Returns an array of socket id for all users in the room ID except for themselves</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getOtherUsersInRoom</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">socketID<span class=\"token punctuation\">,</span> roomID</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> allUsers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> allUsers\n\n    <span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> socketID<span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span>\n        allUsers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> allUsers\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>deleteUser</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>socketID: string</li>\n<li>roomID: string</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Remove the user from the list containing the user's information.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">deleteUser</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">socketID<span class=\"token punctuation\">,</span> roomID</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> roomUsers <span class=\"token operator\">=</span> users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>roomUsers<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n    roomUsers <span class=\"token operator\">=</span> roomUsers<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> user<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> socketID<span class=\"token punctuation\">)</span>\n    users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> roomUsers\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>roomUsers<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">delete</span> users<span class=\"token punctuation\">[</span>roomID<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">delete</span> socketToRoom<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>closeReceiverPC</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>socketID: string</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Close the RTCPeerConnection that the socketID user connected to send his MediaStream, and delete it from the list.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">closeRecevierPC</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">socketID</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>receiverPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n    receiverPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> receiverPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>closeSenderPCs</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>socketID: string</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Close all RTCPeerConnections that were connected to send MediaStream of socketID user to other users, and delete them from the list.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">closeSenderPCs</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">socketID</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>senderPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n    <span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> senderPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        senderPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>pc<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> _senderPCs <span class=\"token operator\">=</span> senderPCs<span class=\"token punctuation\">[</span>senderPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">let</span> senderPC <span class=\"token operator\">=</span> _senderPCs<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sPC</span> <span class=\"token operator\">=></span> sPC<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> socketID<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>senderPC<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            senderPC<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>pc<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            senderPCs<span class=\"token punctuation\">[</span>senderPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _senderPCs<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>\n                <span class=\"token parameter\">sPC</span> <span class=\"token operator\">=></span> sPC<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> socketID\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">delete</span> senderPCs<span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"clientreactjs-typescript\" style=\"position:relative;\"><a href=\"#clientreactjs-typescript\" aria-label=\"clientreactjs typescript permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Client(ReactJS, Typescript)</h2>\n<blockquote>\n<p><strong>Note</strong> <br /> You must use socket.io-client version=2.3.0, @types/socket.io-client version=1.4.34.</p>\n</blockquote>\n<h3>1. Variables to use in the client</h3>\n<ul>\n<li>socket: Sockets to communicate with the server (SocketIOClient.Socket)</li>\n<li>users: Array of users' data (socket id, MediaStream)</li>\n<li>localVideoRef: ref of the video tag on which you want to print your MediaStream</li>\n<li>sendPC: RTCPeerConnection to send your MediaStream to the server</li>\n<li>receivePCs: List of RTCPeerConnections to receive MediaStream from other users in the same room from the server (receivePCs[socket id] = RTCPeerConnection)</li>\n<li>pc_config: RTCPeerConnection setting</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>socket<span class=\"token punctuation\">,</span> setSocket<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>SocketIOClient<span class=\"token punctuation\">.</span>Socket<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>users<span class=\"token punctuation\">,</span> setUsers<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>IWebRTCUser<span class=\"token operator\">>></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> localVideoRef <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useRef</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>HTMLVideoElement<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> sendPC<span class=\"token operator\">:</span> RTCPeerConnection\n<span class=\"token keyword\">let</span> receivePCs<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span>\n\n<span class=\"token keyword\">const</span> pc_config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    iceServers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// {</span>\n        <span class=\"token comment\">//   urls: 'stun:[STUN_IP]:[PORT]',</span>\n        <span class=\"token comment\">//   'credentials': '[YOR CREDENTIALS]',</span>\n        <span class=\"token comment\">//   'username': '[USERNAME]'</span>\n        <span class=\"token comment\">// },</span>\n        <span class=\"token punctuation\">{</span>\n            urls<span class=\"token operator\">:</span> <span class=\"token string\">\"stun:stun.l.google.com:19302\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>2. Socket 수신 이벤트</h3>\n<ul>\n<li>\n<p>userEnter</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>id: The socket id of the user who joined the same room and connected the RTCPeerConnection to which his MediaStream will be sent to the server.</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Generated RTCPeerConnection to receive MediaStream for that user and sent afer to the server</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userEnter\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> string <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">createReceivePC</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> newSocket<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>allUsers</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>users: Array socket id of users who connect RTCPeerConnection to the server to send their MediaStream to the existing room</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Generated RTCPeerConnection to receive MediaStream from those users and sent an offer to the server</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"allUsers\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> users<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> string <span class=\"token punctuation\">}</span><span class=\"token operator\">></span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">.</span>length\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">createReceivePC</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> newSocket<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>userExit</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>id: socket id of disconnected user</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Close the RTCPeerConnection that you connected to receive MediaStream for that user, and delete it from the list</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userExit\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> string <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    receivePCs<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> receivePCs<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span>\n    <span class=\"token function\">setUsers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">users</span> <span class=\"token operator\">=></span> users<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> user<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>getSenderAnswer</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>sdp: RTCSessionDescription received as an answer to the RTCPeerConnection that sent an offfer to send its MediaStream to the server</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Specify sdp as the remoteDescription of the corresponding RTCPeerConnection</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"getSenderAnswer\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> sdp<span class=\"token operator\">:</span> RTCSessionDescription <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> sendPC<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>\n                <span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCSessionDescription</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>sdp<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>getSenderCandidate</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>candidate: RTCIceCandidate sent by the server for RTCPeerConnection to send its MediaStream to the server</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Add RTCIceCandidate to the corresponding RTCPeerConneciton.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"getSenderCandidate\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> candidate<span class=\"token operator\">:</span> RTCIceCandidateInit <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n            sendPC<span class=\"token punctuation\">.</span><span class=\"token function\">addIceCandidate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCIceCandidate</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>getReceiverAnswer</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>id: socket id of user, owner of MediaStream to be sent</li>\n<li>sdp: RTCSessionDescription sent to Answer for the offer of RTCPeerConnection in MediaStream to be sent</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Specify sdp as the remoteDescription of the corresponding RTCPeerConnection</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"getReceiverAnswer\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span> sdp<span class=\"token operator\">:</span> RTCSessionDescription <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> pc<span class=\"token operator\">:</span> RTCPeerConnection <span class=\"token operator\">=</span> receivePCs<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>sdp<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>getReceiverCandidate</p>\n<ul>\n<li>\n<p>data</p>\n<ul>\n<li>id: socket id of user, owner of MediaStream to be sent</li>\n<li>candidate: RTCIceCandidate sent from server for RTCPeerConnection of MediaStream to be sent</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Add RTCIceCandidate to the corresponding RTCPeerConneciton.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"getReceiverCandidate\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span> candidate<span class=\"token operator\">:</span> RTCIceCandidateInit <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> pc<span class=\"token operator\">:</span> RTCPeerConnection <span class=\"token operator\">=</span> receivePCs<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n            pc<span class=\"token punctuation\">.</span><span class=\"token function\">addIceCandidate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCIceCandidate</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h3>3. MediaStream Settings</h3>\n<ul>\n<li>Call the navigator.mediaDevices.getUserMedia() function to obtain your own MediaStream and register it with localVideoRef.</li>\n<li>Create an RTCPeerConnection to transfer your MediaStream and send an offer to the server.</li>\n<li>The server informs the server that he has participated in the room. (Afterwards, the answer will be given to the allUsersocket event.)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">navigator<span class=\"token punctuation\">.</span>mediaDevices\n    <span class=\"token punctuation\">.</span><span class=\"token function\">getUserMedia</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        audio<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        video<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            width<span class=\"token operator\">:</span> <span class=\"token number\">240</span><span class=\"token punctuation\">,</span>\n            height<span class=\"token operator\">:</span> <span class=\"token number\">240</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">stream</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>localVideoRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> localVideoRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> stream\n\n        localStream <span class=\"token operator\">=</span> stream\n\n        sendPC <span class=\"token operator\">=</span> <span class=\"token function\">createSenderPeerConnection</span><span class=\"token punctuation\">(</span>newSocket<span class=\"token punctuation\">,</span> localStream<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">createSenderOffer</span><span class=\"token punctuation\">(</span>newSocket<span class=\"token punctuation\">)</span>\n\n        newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"joinRoom\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            id<span class=\"token operator\">:</span> newSocket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n            roomID<span class=\"token operator\">:</span> <span class=\"token string\">\"1234\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">getUserMedia error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>error<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>4. Function Description</h3>\n<ul>\n<li>\n<p>createReceivePC</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>id: string</li>\n<li>newSocket: SocketIOClient.Socket</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Created RTCPeerConnection to receive MediaStream from other users in the room and sent an offer to the server</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createReceivePC</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">id<span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span> newSocket<span class=\"token operator\">:</span> SocketIOClient<span class=\"token punctuation\">.</span>Socket</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> pc <span class=\"token operator\">=</span> <span class=\"token function\">createReceiverPeerConnection</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> newSocket<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">createReceiverOffer</span><span class=\"token punctuation\">(</span>pc<span class=\"token punctuation\">,</span> newSocket<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>createSenderOffer</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>newSocket: SocketIOClient.Socket</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Create an offer of RTCPeerConnection to send your MediaStream to the server</li>\n<li>Specifies RTCSessionDescription in the localDescription of the corresponding RTCPeerConnection.</li>\n<li>Send RTCSessionDescription via socket to server</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p><strong>Note</strong> <br /> Since RTCPeerConnection is for sending your MediaStream, leave both <strong>offerToReceiveAudio</strong> and <strong>offerToReceiveVideo</strong> as false.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createSenderOffer</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">newSocket<span class=\"token operator\">:</span> SocketIOClient<span class=\"token punctuation\">.</span>Socket</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> sdp <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> sendPC<span class=\"token punctuation\">.</span><span class=\"token function\">createOffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            offerToReceiveAudio<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n            offerToReceiveVideo<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> sendPC<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCSessionDescription</span><span class=\"token punctuation\">(</span>sdp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"senderOffer\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            sdp<span class=\"token punctuation\">,</span>\n            senderSocketID<span class=\"token operator\">:</span> newSocket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n            roomID<span class=\"token operator\">:</span> <span class=\"token string\">\"1234\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>createReceiverOffer</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>pc: RTCPeerConnection</li>\n<li>newSocket: SocketIOClient.Socket</li>\n<li>senderSocketID: string</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Create an offer for RTCPeerConnection to receive MediaStream from senderSocketID user</li>\n<li>Specifies RTCSessionDescription in the localDescription of the corresponding RTCPeerConnection.</li>\n<li>Send RTCSessionDescription via socket to server</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p><strong>Note</strong> <br /> Since RTCPeerConnection is intended to receive MediaStream from other users, both <strong>offerToReceiveAudio</strong> and <strong>offerToReceiveVideo</strong> should be true.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createReceiverOffer</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">pc<span class=\"token operator\">:</span> RTCPeerConnection<span class=\"token punctuation\">,</span>\n    newSocket<span class=\"token operator\">:</span> SocketIOClient<span class=\"token punctuation\">.</span>Socket<span class=\"token punctuation\">,</span>\n    senderSocketID<span class=\"token operator\">:</span> string</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> sdp <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">createOffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            offerToReceiveAudio<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            offerToReceiveVideo<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCSessionDescription</span><span class=\"token punctuation\">(</span>sdp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"receiverOffer\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            sdp<span class=\"token punctuation\">,</span>\n            receiverSocketID<span class=\"token operator\">:</span> newSocket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n            senderSocketID<span class=\"token punctuation\">,</span>\n            roomID<span class=\"token operator\">:</span> <span class=\"token string\">\"1234\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>createSenderPeerConnection</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>newSocket: SocketIOClient.Socket</li>\n<li>localStream: MediaStream</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Create an RTCPeerConnection to send your MediaStream to the server and register localStream</li>\n<li>\n<p>onicecandidate</p>\n<ul>\n<li>Your RTCIceCandidate information event occurred after you created the offer or answer signal.</li>\n<li>Send your RTCIceCandidate information to the server via Socket</li>\n</ul>\n</li>\n<li>\n<p>oniceconnectionstatechange</p>\n<ul>\n<li>Log when ICE connection status is changed</li>\n</ul>\n</li>\n<li>Return generated RTCPeerConnection</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> createSenderPeerConnection <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    newSocket<span class=\"token operator\">:</span> SocketIOClient<span class=\"token punctuation\">.</span>Socket<span class=\"token punctuation\">,</span>\n    localStream<span class=\"token operator\">:</span> MediaStream\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token parameter\">RTCPeerConnection</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> pc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCPeerConnection</span><span class=\"token punctuation\">(</span>pc_config<span class=\"token punctuation\">)</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onicecandidate</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"senderCandidate\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n                candidate<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">,</span>\n                senderSocketID<span class=\"token operator\">:</span> newSocket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">oniceconnectionstatechange</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>localStream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localstream add\"</span><span class=\"token punctuation\">)</span>\n        localStream<span class=\"token punctuation\">.</span><span class=\"token function\">getTracks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">track</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            pc<span class=\"token punctuation\">.</span><span class=\"token function\">addTrack</span><span class=\"token punctuation\">(</span>track<span class=\"token punctuation\">,</span> localStream<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"no local stream\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// return pc</span>\n    <span class=\"token keyword\">return</span> pc\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>createReceiverPeerConnection</p>\n<ul>\n<li>\n<p>parameter</p>\n<ul>\n<li>socketID: string</li>\n<li>newSocket: SocketIOClient.Socket</li>\n</ul>\n</li>\n<li>\n<p>role</p>\n<ul>\n<li>Create RTCPeerConnection to receive MediaStream from socketID user</li>\n<li>Store RTCPeerConnection created in key-value format in receivePCs variable</li>\n<li>\n<p>onicecandidate</p>\n<ul>\n<li>Your RTCIceCandidate information event occurred after you created the offer or answer signal.</li>\n<li>Send your RTCIceCandidate information to the server via Socket</li>\n</ul>\n</li>\n<li>\n<p>oniceconnectionstatechange</p>\n<ul>\n<li>Log when ICE connection status is changed</li>\n</ul>\n</li>\n<li>\n<p>ontrack</p>\n<ul>\n<li>Specifying other users' RTCSessionDescription as remoteSessionDescription in their RTCPeerConnection results in an event about the other user's track data.</li>\n<li>register stream in users variable</li>\n</ul>\n</li>\n<li>Return generated RTCPeerConnection</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> createReceiverPeerConnection <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    socketID<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    newSocket<span class=\"token operator\">:</span> SocketIOClient<span class=\"token punctuation\">.</span>Socket\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token parameter\">RTCPeerConnection</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> pc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCPeerConnection</span><span class=\"token punctuation\">(</span>pc_config<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// add pc to peerConnections object</span>\n    receivePCs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>receivePCs<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>socketID<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> pc <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onicecandidate</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            newSocket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"receiverCandidate\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n                candidate<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">,</span>\n                receiverSocketID<span class=\"token operator\">:</span> newSocket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n                senderSocketID<span class=\"token operator\">:</span> socketID<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">oniceconnectionstatechange</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">ontrack</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setUsers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">oldUsers</span> <span class=\"token operator\">=></span> oldUsers<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> user<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> socketID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setUsers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">oldUsers</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n            <span class=\"token operator\">...</span>oldUsers<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                id<span class=\"token operator\">:</span> socketID<span class=\"token punctuation\">,</span>\n                stream<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>streams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// return pc</span>\n    <span class=\"token keyword\">return</span> pc\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>5. Video rendering of yourself and your opponent</h3>\n<ul>\n<li>IWebRTCUser: Interface used to store users</li>\n<li>Props: Props used for Video Tags</li>\n<li>Video: Component to print video of the other party</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">IWebRTCUser</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n    email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n    stream<span class=\"token operator\">:</span> MediaStream\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">Props</span> <span class=\"token punctuation\">{</span>\n    email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n    stream<span class=\"token operator\">:</span> MediaStream\n    muted<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Video</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> email<span class=\"token punctuation\">,</span> stream<span class=\"token punctuation\">,</span> muted <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> Props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useRef</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>HTMLVideoElement<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isMuted<span class=\"token punctuation\">,</span> setIsMuted<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token builtin\">boolean</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> ref<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> stream\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>muted<span class=\"token punctuation\">)</span> <span class=\"token function\">setIsMuted</span><span class=\"token punctuation\">(</span>muted<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Container</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">VideoContainer</span></span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>ref<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">muted</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>isMuted<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">autoPlay</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">VideoContainer</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserLabel</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>email<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">UserLabel</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Container</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>video</span>\n            <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n                width<span class=\"token operator\">:</span> <span class=\"token number\">240</span><span class=\"token punctuation\">,</span>\n                height<span class=\"token operator\">:</span> <span class=\"token number\">240</span><span class=\"token punctuation\">,</span>\n                margin<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n                backgroundColor<span class=\"token operator\">:</span> <span class=\"token string\">\"black\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n            <span class=\"token attr-name\">muted</span>\n            <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>localVideoRef<span class=\"token punctuation\">}</span></span>\n            <span class=\"token attr-name\">autoPlay</span>\n        <span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>video</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token punctuation\">{</span>users<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Video</span></span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>index<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">email</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>user<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">stream</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>user<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h1 id=\"github\" style=\"position:relative;\"><a href=\"#github\" aria-label=\"github permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[GitHub]</h1>\n<ul>\n<li><a href=\"https://github.com/millo-L/Typescript-ReactJS-WebRTC-1-N-SFU\">https://github.com/millo-L/Typescript-ReactJS-WebRTC-1-N-SFU</a></li>\n</ul>\n<h1 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[References]</h1>\n<ul>\n<li><a href=\"https://millo-l.github.io/Implementing-WebRTC-using-ReactJS-and-Typescript(1-N-P2P)/\">https://millo-l.github.io/Implementing-WebRTC-using-ReactJS-and-Typescript(1-N-P2P)/</a></li>\n<li><a href=\"https://millo-l.github.io/WebRTC-implementation-method(Mesh-SFU-MCU)/\">https://millo-l.github.io/WebRTC-implementation-method(Mesh-SFU-MCU)/</a></li>\n</ul>","id":"b662e49a-1f70-50d4-b140-5c57494521b2","tableOfContents":"<ul>\n<li><a href=\"#1-introduction\">1. Introduction</a></li>\n<li>\n<p><a href=\"#2-code\">2. Code</a></p>\n<ul>\n<li><a href=\"#sfu-servernodejs\">SFU Server(Node.js)</a></li>\n<li><a href=\"#clientreactjs-typescript\">Client(ReactJS, Typescript)</a></li>\n</ul>\n</li>\n<li><a href=\"#github\">GitHub</a></li>\n<li><a href=\"#references\">References</a></li>\n</ul>","frontmatter":{"author":"millo","description":"Based on the theory of WebRTC, let's implement 1:N SFU real-time video transmission.","category":"webrtc","released_at":"2021-03-05","updated_at":null,"tags":["WebRTC","SFU","Media Server","nodejs","reactjs","typescript"],"title":"Implementing WebRTC using ReactJS and Typescript (1:N SFU)","lang":"en","series":"WebRTC theory to practice","translation":"/WebRTC-구현하기-1-N-SFU/","image":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABI0lEQVQoz41Sz0uEQBT2L5S6dxeCLh26eZIMoj2W5iUPUpJCwgaFoLCVhIgoRuytWyAdOiWyOeOX4zLbrsWyH7xf8948vnlvBHRo2xaU0oWwmJ91Zm4p6Xy6UrcsvI/A1Fq0FJuA9xGYqusaWZZhMpkgSRJUVYWyLPH6UvRF07GPr+sLfHy+4+rShu/7ME0TQRDAcRwUxbyOMRU4XVVVIYoiJEmCLMs4VI+wv7eL05t7jB/eQKbnuLs9wNb2DnT9DJZlQVEUeJ7Xk1k8mRDSB2EYwnVd2LYNwzD6CyejEdLnCN+Zi+NCR5A/IvQDPEUR0jRFnufQNA1xHP8y5M7a+TQzkKbZbIbc4dtijIcb5Guj7epPWPb/bJl/laEMc6z7fzmOH+JoUHn0gycpAAAAAElFTkSuQmCC","aspectRatio":2.4691358024691357,"src":"/static/5d1a4dc7a92facc014378e28932bee9a/8a558/webrtc.png","srcSet":"/static/5d1a4dc7a92facc014378e28932bee9a/69585/webrtc.png 200w,\n/static/5d1a4dc7a92facc014378e28932bee9a/497c6/webrtc.png 400w,\n/static/5d1a4dc7a92facc014378e28932bee9a/8a558/webrtc.png 539w","sizes":"(max-width: 539px) 100vw, 539px"}}}},"fields":{"slug":"/Implementing-WebRTC-using-ReactJS-and-Typescript(1-N-SFU)/"}},"site":{"siteMetadata":{"siteUrl":"https://millo-L.github.io"}},"allMarkdownRemark":{"edges":[{"node":{"frontmatter":{"title":"About WebRTC","lang":"en"},"fields":{"slug":"/About-WebRTC/"}}},{"node":{"frontmatter":{"title":"WebRTC implementation method(Mesh, SFU, MCU)","lang":"en"},"fields":{"slug":"/WebRTC-implementation-method(Mesh-SFU-MCU)/"}}},{"node":{"frontmatter":{"title":"Implementing WebRTC using ReactJS and Typescript (1:1 P2P)","lang":"en"},"fields":{"slug":"/Implementing-WebRTC-using-ReactJS-and-Typescript(1-1-P2P)/"}}},{"node":{"frontmatter":{"title":"Implementing WebRTC using ReactJS and Typescript (1:N P2P)","lang":"en"},"fields":{"slug":"/Implementing-WebRTC-using-ReactJS-and-Typescript(1-N-P2P)/"}}},{"node":{"frontmatter":{"title":"Implementing WebRTC using ReactJS and Typescript (1:N SFU)","lang":"en"},"fields":{"slug":"/Implementing-WebRTC-using-ReactJS-and-Typescript(1-N-SFU)/"}}},{"node":{"frontmatter":{"title":"WebRTC Performance Comparison (P2P vs SFU)","lang":"en"},"fields":{"slug":"/WebRTC-Performance-Comparison-(P2P-vs-SFU)/"}}}]}},"pageContext":{"slug":"/Implementing-WebRTC-using-ReactJS-and-Typescript(1-N-SFU)/","series":"WebRTC theory to practice"}},"staticQueryHashes":["1608878238","3469517283","764694655"]}